"""
Trajectory Optimization for a 6-DOF Robot Joint Path

Steps:
    1. Load waypoints from "waypoints.csv". (CSV file expected to have 6 columns.)
    2. Set initial interval dt_init = 0.5 sec.
    3. For each sliding window of N_to_be_opt=5 waypoints, generate an interpolating spline trajectory with the 4th order polynomial formula.
       (which will pass exactly through the waypoints) with a time resolution of 4ms.
    4. Compute joint velocities and accelerations. 
    5. If any joint’s velocity or acceleration exceeds its limit, increase dt and go to step 4.
    6. If all joints are comfortably within 80% of their limits, reduce dt and go to step 4.
    7. We found the optimal time stamp for the third way point in the sliding window. Save this one as the optimal time stamp of the third way point. 
    8. Slide the window (e.g., waypoints 1–6, then 2–7, etc.) until all waypoints are processed.
    9. Once we find all the optimal dts for all the waypoints, we can compute the final trajectory with the Catmull-Rom spline algoroithm. Its time resolution needs to be 4ms. 
    10. Compute joint velocities and accelerations numerically. 
    11. Visualize the final trajectories and the original waypoints, including velocity/acceleration limit lines. Make the figures separately for positions, vel, and acc. For the vel and acc, subfigures for individual joints. 
    12. Generate a concise log file ("trajectory_log.txt") for debugging purposes.

    * During the 4th order polynomial fitting, use the previously discovered optimal time interval between two way points as the time interval optimization starting point. 
    * For the first window, find one optimal dt representing all time intervals between all way points within the constraints. Then use the optimal dt to dtermine the time stamps of the first, second, and third way points. 
"""

# This is the constraint of joints. 
#     q_dot_max = np.array([3.0543, 2.7576, 3.0543, 4.0, 4.3633, 5.0])
#     q_ddot_max = np.array([10.0, 1.5, 1.34, 17.0, 14.0, 17.0])

# The generated code needs to have visualization feature to show the results. Save the figure as a png file. A figure shows the optimized joint trajectory and evenly distributed way points. Figures need to show the vel and acc with their limits. 
# Generate a log file for future debugging purpose. Make the log file concise. I will feed this file back to you. 
# I am attaching a sample way point file. Write codes to work with this format of waypoint file. 

joint_1,joint_2,joint_3,joint_4,joint_5,joint_6
1.0692498858715331,-1.602958381649998,1.809139597397077,-4.4740721689297267e-05,1.3645504927221377,0.2865560964759617
1.0452450444924055,-1.6074511339164954,1.81552522945841,0.03694872030445703,1.3520875465779758,0.22681837544506195
0.9718051105202579,-1.6211961707860865,1.8350613051003226,0.15012577872583382,1.3139586571814594,0.04405798062027033
0.8485382579910559,-1.6442668265066502,1.8678520556484406,0.34009027100611955,1.249960394490685,-0.26270017422216557
0.6754295231494223,-1.6766659016984784,1.9139014616762902,0.6068652575393658,1.160084989552947,-0.693493327430551
0.4745977989007989,-1.7142536186948991,1.967325580463009,0.9163636810642637,1.0558162329376217,-1.193277072210908
0.27367917524999796,-1.7518575998057089,2.020772815736935,1.225996023809742,0.951502359483064,-1.6932770722109118
0.0727605515991978,-1.7894615809165184,2.074220051010861,1.535628366555219,0.8471884860285068,-2.193277072210914
-0.12815807205160246,-1.8270655620273284,2.1276672862847867,1.8452607093006963,0.7428746125739496,-2.693277072210916
-0.3290766957024037,-1.8646695431381382,2.1811145215587127,2.1548930520461753,0.6385607391193918,-3.193277072210921
-0.517144393356263,-1.8998683416448439,2.231143226221758,2.4447210468891045,0.5409188697023928,-3.661296647092951
-0.6568263673859054,-1.92783778247198,2.2691216821127638,2.6530694925125156,0.4632907779294557,-4.002356392514871
-0.7513142713017326,-1.946930974845377,2.2948122138994127,2.7936739206397445,0.40999015674290895,-4.232646474831794
-0.8025863057088214,-1.954853977121461,2.307131951918135,2.874689676609375,0.38646445631964277,-4.361727022849875
-0.8346932429849186,-1.9529930026295812,2.3067868236688347,2.9101730574904483,0.3761814491086608,-4.424684702343164
-0.8603114155545841,-1.9423039183758324,2.295310424285989,2.9153624583767224,0.37186600359188443,-4.448476646856984
-0.8842451884897753,-1.921795137091098,2.271711787016397,2.8935274989182593,0.371703286278413,-4.440349098436717
-0.9081730451797626,-1.890958806446918,2.235332567449203,2.845734097470431,0.3753660942385293,-4.402609967577618
-0.9348729218969245,-1.849433425589469,2.185744650146823,2.775166683857323,0.3822051040903528,-4.340721032746357
-0.9663957297654244,-1.797009242452551,2.1228478826607087,2.683422631479749,0.39177351526422594,-4.257891061586871
-1.0046127211431786,-1.7333944300331436,2.0467517312903603,2.570710283642427,0.40374313943152074,-4.155751876508072
-1.0507252542666574,-1.6581460850029954,1.9575020298306036,2.4358546207163587,0.4182532204188465,-4.033643457184015
-1.09656317973969,-1.5730865041228839,1.8550430933633555,2.29236664043565,0.43071960295331857,-3.9028544412800223
-1.1137110899062068,-1.4847160866216447,1.739779386882842,2.1768813350718794,0.4232945450970321,-3.79158635766012
-1.1005565598599318,-1.3934927598282076,1.6116955315617225,2.0870489901436615,0.39428872115602687,-3.6966631961045637
-1.0810705767770012,-1.3046592965610424,1.485325324764687,2.006553129571557,0.3615161507737491,-3.6092582294237245
-1.0632326434318078,-1.224986790875275,1.3723828706426708,1.936348045640152,0.3319303268795534,-3.5328513521026803
-1.047511082611753,-1.1547669890862702,1.2728404165206528,1.874472408168839,0.3058546980069204,-3.465509729862739
-1.0339058943168373,-1.0939998911940298,1.1866979623986351,1.8209262171576188,0.2832892641558506,-3.407233362703902
-1.0224170785470603,-1.0426854971985546,1.1139555082766188,1.7757094726064924,0.2642340253263442,-3.3580222506261705
-1.0130446353024223,-1.000823807099842,1.054613054154601,1.7388221745154575,0.24868898151840052,-3.317876393629542
-1.0057885645829228,-0.968414820897894,1.008670600032583,1.710264322884516,0.23665413273202002,-3.2867957917140176
-1.0006488663885629,-0.9454585385927121,0.9761281459105684,1.690035917713669,0.22812947896720343,-3.2647804448796
-0.9976255407193413,-0.9319549601842925,0.9569856917885509,1.6781369590029132,0.22311502022394925,-3.2518303531262847
-0.9967131841181986,-0.9278799513205794,0.9512090251998039,1.6745461802664376,0.22160179438058736,-3.247922371324383